<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/iron-swipeable-container/iron-swipeable-container.html">

<dom-module id="events-list">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      span,
      input {
        @apply(--paper-font-body2);
      }

      paper-icon-button {
        color: #B22222;
      }

      paper-fab {
        margin: 0;
        bottom: 20px;
        right: 14px;
        background-color: #d23f31;
        height: 56px;
        position: fixed;
        width: 56px;
        cursor: pointer;
      }

      paper-material {
        width: calc(98% - 46px);
        margin-bottom: 36px;
        padding-left: 30px;
        padding-right: 30px;
      }

      .tapableEvents {
        cursor: pointer;
      }

      .ironD {
        position: absolute;
        right: 40px;
      }

      .beforeAfter::before {
        content: "Swipe to delete";
      }
    </style>

    <template is="dom-if" if="{{!events.length}}">
      <paper-material id="noEvents" elevation="1">
        <h1 class="page-title" tabindex="-1">No events</h1>
      </paper-material>

      <a data-route="newEvent" href="{{baseUrl}}newEvent">
        <paper-button class="fbtn no-margin" toggles raised><iron-icon icon="create"></iron-icon>Create new event?</paper-button>
      </a>
    </template>
    
    <template is="dom-if" if="{{events.length}}">

      <iron-swipeable-container on-iron-swipe="mySwipeDelete" title="Swipe to delete, click to load">
        <template id="list" is="dom-repeat" items="[[events]]">
          <paper-button class="block-level no-padding no-margin" item={{item}}>
            <paper-material id="eventDt" elevation="1" on-tap="myLoad" class="tapableEvents">
              <iron-icon class="ironD" icon="chevron-right"></iron-icon>
            	<label>Name of event: <b style="color: blue;">{{item.name}}</b><hr> Number of counters: <b style="color: green;">{{item.counters.length}}</b></label>
                
              <div style="text-align: right">
                <paper-icon-button on-click="myLoad" icon="file-upload" style="color: blue;"></paper-icon-button>
              </div>

            </paper-material>
          </paper-button>
        </template>
      </iron-swipeable-container>

      <a data-route="newEvent" href="{{baseUrl}}newEvent">
        <paper-fab icon="add" title="New event"></paper-fab>
      </a>


    </template>

    <paper-toast id="undoToast" duration="0">
      Deleting item...
      <paper-button on-tap="undo">Undo</paper-button>
    </paper-toast>

  </template>

  <script>
    Polymer({
      is: 'events-list',
      ready: function() {
        app.lForageLoadAll();
      },
      properties: {
        events: {
          type: Array,
          default: f => {
            return [];
          }
        }
      },

      // listeners: {
      //   'iron-swipe': 'mySwipeDelete'
      // },

      myLoad: function(e) {
        var event = e.model.item;
        console.log('Load event: ' + '"' + event.name + '"' + ' with id: ' + event.id);
        app.set('selectedEvent', event);
        page.redirect('/');
      },

      mySwipeDelete: function(e) {
        var event = e.detail.target.get('item');
        console.log('Remove event: ' + '"' + event.name + '"' + ' with id: ' + event.id);
        app.lForageRemoveEvent(event);
        document.querySelector('#deleteEventList').toggle();
      },


      myDeleteUndo: function(e) {
        var event = e.detail.target.get('item');
        console.log('Remove event: ' + '"' + event.name + '"' + ' with id: ' + event.id);

        const idx = document.querySelector('#list').indexForElement(e.detail.target);
        const item = this.events[idx];
        console.log('Test: ' + item[0] + ' and ' + item[0]);
        this.splice('events', idx, 1);
        console.log('Test 1');
        // Give user 3 sec to undo before the item is really deleted
        const timeoutId = (item => setTimeout(() => {
          this.$.undoToast.close();
          // this.api.delete(item);
          app.lForageRemoveEvent(event);
         }, 3000))(item);
         console.log('Test 2');

        this.$.undoToast.undoHandler = ((idx, item, timeoutId) => () => {
          // Cancel scheduled deletion
          clearTimeout(timeoutId);

          // Bring back item
          this.splice('events', idx, 0, item);
        })(index, item, deleteTimeoutId);

        console.log('Open Toast');
        this.$.undoToast.open();
        //document.querySelector('#undoToast').toggle();
      },

      undo: function(e) {
        this.$.undoToast.undoHandler();
        this.$.undoToast.close();
      },




      myDelete: function(e) {
        var event = e.model.item;
        console.log('Remove event: ' + '"' + event.name + '"' + ' with id: ' + event.id);
        app.lForageRemoveEvent(event);
      }

    });
  </script>
</dom-module>
